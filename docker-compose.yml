version: '3.8'

services:
  # ============================================
  # DATABASES (One per service)
  # ============================================

  auth-db:
    image: postgres:16-alpine
    container_name: auth-db
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  user-db:
    image: postgres:16-alpine
    container_name: user-db
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - user-db-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  task-db:
    image: postgres:16-alpine
    container_name: task-db
    environment:
      POSTGRES_DB: task_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - task-db-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification-db:
    image: postgres:16-alpine
    container_name: notification-db
    environment:
      POSTGRES_DB: notification_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - notification-db-data:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # REDIS (Message Queue)
  # ============================================

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # MAILPIT (Email Testing)
  # ============================================

  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    environment:
      MP_MAX_MESSAGES: 5000
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1

  # ============================================
  # BACKEND SERVICES
  # ============================================

  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    environment:
      AUTH_SERVICE_PORT: 4001
      DATABASE_URL: postgresql://postgres:postgres@auth-db:5432/auth_db
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production-min-32-chars}
      JWT_EXPIRES_IN: 15m
      REFRESH_TOKEN_EXPIRES_IN: 7d
    ports:
      - "4001:4001"
    depends_on:
      auth-db:
        condition: service_healthy

  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service
    environment:
      USER_SERVICE_PORT: 4002
      DATABASE_URL: postgresql://postgres:postgres@user-db:5432/user_db
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production-min-32-chars}
    ports:
      - "4002:4002"
    depends_on:
      user-db:
        condition: service_healthy

  task-service:
    build:
      context: ./services/task-service
      dockerfile: Dockerfile
    container_name: task-service
    environment:
      TASK_SERVICE_PORT: 4003
      DATABASE_URL: postgresql://postgres:postgres@task-db:5432/task_db
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production-min-32-chars}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "4003:4003"
    depends_on:
      task-db:
        condition: service_healthy
      redis:
        condition: service_healthy

  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    environment:
      NOTIFICATION_SERVICE_PORT: 4004
      DATABASE_URL: postgresql://postgres:postgres@notification-db:5432/notification_db
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production-min-32-chars}
      SMTP_HOST: mailpit
      SMTP_PORT: 1025
      SMTP_FROM: noreply@microservices-demo.local
    ports:
      - "4004:4004"
    depends_on:
      notification-db:
        condition: service_healthy
      mailpit:
        condition: service_started

  queue-worker:
    build:
      context: ./services/queue-worker
      dockerfile: Dockerfile
    container_name: queue-worker
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      NOTIFICATION_SERVICE_URL: http://notification-service:4004
    depends_on:
      redis:
        condition: service_healthy
      notification-service:
        condition: service_started

# ============================================
# VOLUMES
# ============================================

volumes:
  auth-db-data:
  user-db-data:
  task-db-data:
  notification-db-data:
